pipeline{
    agent{
        label "physical"
    }

    environment{
        DOCKER_REGISTRY = "docker.io"
        DOCKERHUB_USERNAME = "kng1259"
        DOCKER_CREDENTIALS_ID = "dockerhub-credentials"
        IMAGE_TAG = "0.0.1"
    }

    stages{
        stage('Checkout'){
            steps{
                checkout scm
            }
        }

        // Using docker plugin
        // Assuming docker and az cli is installed on the agent
        stage('Build'){
            steps{
                dir('backend'){
                    script{
                        dockerImage = docker.build("${DOCKERHUB_USERNAME}/iot-backend:${IMAGE_TAG}")
                    }
                }
                dir('backend/prisma'){
                    script{
                        dockerInitImage = docker.build("${DOCKERHUB_USERNAME}/iot-backend-init:${IMAGE_TAG}", "-f Dockerfile.init .")
                    }
                }
            }
        }

        stage('Push to Registry'){
            steps{
                script{
                    docker.withRegistry("https://${DOCKER_REGISTRY}", DOCKER_CREDENTIALS_ID){ 
                        try{
                            dockerImage.push()
                            dockerInitImage.push()
                        }catch(Exception e){
                            error "Failed to push to registry: ${e}"
                        }
                    }
                }
            }
        }

        stage('Deploy'){
            steps{
                script{
                    sh 'az containerapp update -n container-app-lola -g dev-rg --set image=${DOCKER_REGISTRY}/${DOCKERHUB_USERNAME}/iot-backend:${IMAGE_TAG}'
                }
            }
        }
    }
}